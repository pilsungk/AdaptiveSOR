# Adaptive SOR
The code here is an examplary implementation of adaptive SOR (successive over-relaxation) via [AspectC++](https://www.aspectc.org), as described in the uploaded manuscript (ase2023.pdf). The following instructions show how an old Fortran code can be adapted in a modular fashion using modern software engineering techniques, specifically AOP (aspect-oriented programming). 

## Build Environment Setup
The code has been tested and built on GNU/Linux, specifically on the Ubuntu 20.04 LTS distribution.

1. gfortran
  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`sudo apt install gfortran`

2. AspectC++ compiler
  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `sudo apt install aspectc++`

3. ITPACK 2C source code
You can get the ITPACK 2C source *(dsrc2c.f)* and test code *(dtst2c.f)* at https://www.netlib.org/itpack/index.html. However, these are not directly compilable by gfortran since the codes too old for modern Fortran language syntax. For instance, a few subroutines such as `perror` need to be explicitly declared as external. In addition, the `ITSOR` subroutine needs to be separated into its own translation unit in order to apply the GCC linker's [link-time wrap](https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html) functionality. Hence, there are three Fortran source files here.
  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `dsrc2c_wo_itsor.f, itsor.f, dtst2c.f`

4. Checking the original behavior
  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Build: `gfortran -fno-automatic *.f -o dtst2c`
  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Run: `./dtst2c`

  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The ITPACK test program will generate *'result.out'*, as uploaded here renamed as *'result_orig.out'*, which shows how the original ITPACK SOR algorithm operates for the test problem.

## Adjusting the SOR parameter of ITPACK
1. Files needed
- C wrapper for the ITSOR Fortran subroutine: *itsor.c* (generated by our own versio of C wrapper generator which was based on previous version of [F2PY](https://numpy.org/doc/stable/f2py)
- Aspect C++ code for adjusting the SOR parameter at ITSOR calls: *ControlSystems.ah* (base aspect code), *SORParamControl.ah* (derived aspect code for ITPACK SOR parameter adjustment). 

2. Aspect weaving via AspectC++ compiler
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `ac++ -c itsor.c -p. -a SORParamControl.ah -o itsor_weaved.cpp`

<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This will generate a standard C++ source code, *itsor_weaved.cpp*, where the `ITSOR` calls are weaved with the parameter adjusting aspect code. 

3. Compiling each source code
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *itsor_weaved.cpp*: `g++ -c itsor_weaved.cpp`
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all the Fortran code *(itsor.f, dtst2c.f, and dsrc2c_wo_itsor.f)*: `gfortran -fno-automatic -c *.f`

4. Linking the object code with link-time wrap for the ITSOR calls
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `g++ *.o -Wl,--wrap=itsor_ -o dtst2c_ac -lgfortran`

<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This will build a ITPACK test program, *'dtst2c_ac'*, where the SOR parameter, &omega;, is adjusted at each `ITSOR` calls. For the illustration purposes, we adjust the &omega; value by 0.995 at each `ITSOR` iteration in our adaptive scenario.   

5. Running the adaptive ITPACK test program
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `./dtst2c_ac`

<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The adapted ITPACK test program will generate *'result.out'*, which shows how the adaptive version of ITPACK SOR operates. You can compare this with *'result_orig.out'* to see how differently the two versions of SOR behaved.
